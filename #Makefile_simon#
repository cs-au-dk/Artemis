#Set QTDIR for your system
QTDIR=/Users/shjensen/src/hg/artemis2/qt-install

#The revision instrumented against
REVISION=73510

artemis:
	cd artemis-code && qmake && make

artemis-clean:
	cd artemis-code && qmake && make clean

artemis-standalone:
	macdeployqt artemis-code/dist/artemis.app/ -verbose=2
	cp artemis-code/dist/artemis.app/ .

webkit: compile-webkit-qt compile-webkit-safari

webkit-qt:	
	./WebKit/WebKitTools/Scripts/build-webkit --qt --debug
	@echo "Now run make install-qt-webkit to install the new build"

webkit-safari:	
	./WebKit/WebKitTools/Scripts/build-webkit --debug

install-qt-webkit:
#Fix weird mistake in the generated QtWebKit header
	@sed "s/\\\//g"  $(QTDIR)/include/QtWebKit/QtWebKit > xx && mv xx  $(QTDIR)/include/QtWebKit/QtWebKit 

qt-browser:
	WebKit/WebKitTools/Scripts/run-launcher --qt --debug

safari-browser:
	WebKit/WebKitTools/Scripts/run-safari --debug

download-qt:
	wget http://get.qt.nokia.com/qt/source/qt-everywhere-opensource-src-4.7.1.tar.gz
	tar -xvzf qt-everywhere-opensource-src-4.7.1.tar.gz

pristine-webkit:
	@if test -e webkit-rev$(REVISION).tar.gz; then echo "" ; else wget http://cs.au.dk/~simonhj/webkit-rev$(REVISION).tar.gz; fi 	
	tar -xvzf webkit-rev$(REVISION).tar.gz 

get-webkit-source-svn:
	echo "This will check out revision $(REVISION) used in Artemis"
	svn checkout -r$(REVISION) http://svn.webkit.org/repository/webkit/trunk WebKit

get-new-webkit-source-svn:
	echo "This will get the latest SVN version of webkit"
	svn checkout http://svn.webkit.org/repository/webkit/trunk WebKit

diff:
	- diff -ur --exclude-from=diff-exclude --new-file WebKit-pristine/WebCore/ WebKit/WebCore/ > webcore-instrumentation.patch
	- diff -ur --exclude-from=diff-exclude --new-file WebKit-pristine/JavaScriptCore/ WebKit/JavaScriptCore/ > javascriptcore-instrumentation.patch
	- diff -ur --exclude-from=diff-exclude --new-file WebKit-pristine/WebKit/ WebKit/WebKit/ > webkitapis-instrumentation.patch	

patch:
	- patch -p0 < webcore-instrumentation.patch 
	- patch -p0 < webkitapis-instrumentation.patch 
	- patch -p0 < javascriptcore-instrumentation.patch

commit:
	svn ci -m ""

gdb:
	gdb ./artemis-code/dist/artemis

dist:
	mkdir -p artemis2011
	@cp -rv artemis-code/ *.patch LICENSE README Makefile artemis2011/ 
	tar --exclude ".svn" --exclude "build" -cvzf artemis2011.tar.gz artemis2011
	yes | rm -r artemis2011

state-index-files:
	od -txC -v artemis-code/etc/index-footer.html | sed -e "s/^[0-9]*//" | tr -s " " | sed -E -e "s/([0-9a-f]+)/0x\1,/g" > artemis-code/src/index-footer.dat 
	od -txC -v artemis-code/etc/index-header.html | sed -e "s/^[0-9]*//" | tr -s " " | sed -E -e "s/([0-9a-f]+)/0x\1,/g" > artemis-code/src/index-header.dat
